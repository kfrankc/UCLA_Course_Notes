# Exploits: Buffer Overflows, Pathname Attacks, SQL Injections

## Overview

1. Identify and Describe
	* Buffer Overflows
	* Pathname Attacks
	* SQL Injection Attacks
2. Identify above bugs in preexisting code
	* small webserver written in C
	* CGI script in Perl
	* MySQL based application in PHP
3. Understand how vulnerabilities lead to
	* software crashes
	* remote execution exploits
	* unauthorized access to private data
4. Repair simple examples of these kinds of security holes in above language
5. Author memos describing in detail your findings and code changes

## Required Reading

### Buffer Overflows

* a buffer is a bounded region of memory into which data can be stored.
* buffer overflow is when buffer assigned more data than it can hold
	* "overflows" into the next available memory space, overwriting data
* how buffers are different from traditioinal variables
	* each genuine type is of a _fixed_ **AND** _predetermined_ size. 
	* 'int' in C is 32-bit signed integer
		* should never exceeed 32 bits of storage space
* buffer is allocated with specified amount of space (upper bound) and type
	* accessed via pointer to the first byte of the buffer
	* spatial locality: allocated buffers will have positional relationship in the physical memory

#### How to get rekt

* neglecting to make sure inptu from outside world will fit into declared size of buffer
* _def_ of buffer overflow: Buffer of size _b_ is assigned data of size _c_ where c > b
* used to create DOS attacks
* the scary part: overwrite the function pointer on the stack to _control_ the next step the program wil take after reading the new input. 
* Possible to dynamically rewrite the program then program will jump to code you provided.
* you can remotely execute code on the running software.

#### How to protect this
* **input validation** is absolutely critical when writing any software. 
	* ensure that all accepted input fits within the logical constraints of the application
	* ex. compiler for syntax, excluding extraneous letters in input
	* part of the _principle of least privilege_

### Pathname Attacks

* filesystem permissions and pathnames are critical entities for protecting data
* unprivileged attackers have to subvert this system
	* breaking it
	* circumventing it
* unfortunately, while it is hard to break the permissions system, it is easy to violate intent of system permissions while still makking permissible requests

#### Comon Approaches

* use the permissions of an application to take an action on behalf of attacker
* `group` and user `other` permissions are usually overlooked.
* some apps run special 'non-privileged' user as a security measure with the express intention of limiting its privileges. 
	* ex. Apache Web Server runs as the user `www-data`, for non-login, limited user
	* any files or directories the webserver uses or creates must be readable or writable by the user
	* all web apps on a server runs as the same user
	* One web app can be vulnerable to an attack from a different web app on the same server

#### SUID

* used if program must do something with root user privileges such as changing a user's password
* possible leverage by attackers on this permission

#### Pathnames

* **input validation**: make sure that they are capable of properly validating all potential pathnames they could receive, rather than assuming any arbitrary limit on the form or content of pathnames
* program running on a system is a direct extension of the entity with whose permissions the program is running.
	* your mail client is an extension of you and your authentication level
	* blessing and curse: permissions that allow the mail client to do its job are the same permissions that make it a desirable target for attack

### SQL Injection Description

* SQL: Structured Query Language
* LAMP Stack: Linux Servers, Apache http daemon, the MySQL relational database, the PHP scripting language
* SQL allows programmers to ignore the particulars of the database internals
	* use standardized query language to access the data they need

#### MySQL Vulnerabilities

* performance critical code (the database) written in C/C++
* interface created with scripting language
* simple programming mistakes often result in unexpected negative security effects
* PHP is vulnerable to filesystem and directory traversal exploits
	* occur because of a lack of input validation
	* input is trusted to be valid and not malicious

##### What is SQL Injection
* insert user input into the application's own request
* ex. use wildcard 
```sql
SELECT * FROM personal WHERE ssn LIKE '%'
```
* **unnecessary privilege**: don't use `LIKE`, but use exact matching
* **input validation**: check for exactly 9 digit queries

## Software Tools

### `wget`: non-interactive command-line network client

* command-line web client useful for scripting interactions with servers

### `telnet`: cleartext remote shell

* TELNET: cleartext remote terminal protocol. 
* user issues commands over a TCP socket, server replies with the result of those comamnds and waits for more input later

### `netcat`: network swiss army knife

* Unix utility for creating and using TCP and UDP sockets
* acts like a telnet client and server without any built in protocol or terminal emulation
* ex. to send a file to the host `receiver` at port `1000`:

```
$ cat attackscript.txt | netcat receiver 1000
```

### CRLF vs. LF newlines: line endings and network protocols

* file is a stream of characters
* humans read lines of text, how does computers know where one line ends and another begins?
* two common newline character sequences, and most systems expects one or the other for text files
* CRLF (carriage return followed by line-feed) used by Windows
* LF (line-feed) used by Unix
* ex. notepad in Windows add CRLF to end of each line
	* Wordpad in Windows ONLY uses LF, and can save in either Unix or DOS format
	* vim on Unix uses LF by default, BUT will use CRLF endings if the file is in DOS mode
	* force vim to use DOS by: `:set fileformat=dos`

### Scripting Exploits

* edit scripts in DOS mode or make sure that you are using CRLF as line endings instead of LF

### diff and patch: see differences and create source patches

* to see differences between two files on Unix, use `diff`: `$ diff one.txt two.txt`
* to take diff output and apply changes to original file: `$ diff -Naur oldcode.c newcode.c > fixed.patch`
* makes patching as simple as `$ patch < fixed.patch`

### mysql: command line mysql client
* to use MySQL commad line on server: `$ mysql -uroot -pzubaz99`
* SQL shell that gives you root access
```
mysql> use fccu; # selects the fccu database
mysql> select * from accounts; # print all accounts information
mysql> select * from accounts where id > 50
```

### Restarting servers: bring a server back to life

* to restart a server: `$ sudo /etc/init.d/servername restart`
* restart fhttpd to verify exploit worked: `$ sudo /etc/init.d/fhttpd.init restart`

### running fhttpd manually

* running a server manually is a good approach to debug it
* `$ sudo ./fhttpd <portnumber>`

### HTTP and CGI Protocols: sending commands to servers

* web server is an application that takes input over TCP port 80, and responds to the client based on the outcome of the request
* the language that web servers spead is HTTP
* if request is successful, server will provide the requested information along with a success message as defined in the protocol. 
* RFC 1945 defines a version of HTTP, and is a good resource for understanding the HTTP protocol. You can also look at the above section on `telnet`, which provides an example of simple request
* Common Gateway Interface (CGI): passing arguments to and from web applications

### Useful lines of code

**SSH**: `ssh la136ae@users.deterlab.net -L 8118:server.la136ae-exploit.UCLA136.isi.deterlab.net:80`




